<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>交互式 MacBook 键盘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif,
          "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
          "Noto Color Emoji";
      }
      .key {
        display: flex;
        position: relative;
        box-sizing: border-box;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 500;
        border-radius: 0.375rem;
        background-color: #444;
        color: #f5f5f5;
        border: 1px solid #333;
        box-shadow: 0 2px 0 #222, 0 3px 3px rgba(0, 0, 0, 0.4);
        transition: all 0.08s ease-in-out;
        -webkit-user-select: none;
        user-select: none;
        cursor: pointer;
      }
      /* -- 按键被物理按下或鼠标点击时的亮起效果 -- */
      .key-pressed {
        transform: translateY(1px);
        box-shadow: 0 1px 0 #111, 0 0px 8px rgba(76, 162, 248, 0.7),
          inset 0 0 2px rgba(255, 255, 255, 0.2);
        background-color: #5a5a5a;
        border-color: #4cacff;
        color: white;
      }
      .key .symbol {
        position: absolute;
        top: 0.375rem;
        left: 0.5rem;
        font-size: 0.8rem;
        font-weight: 400;
        color: #ccc;
      }
      .key .zh-label {
        position: absolute;
        bottom: 0.375rem;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 0.65rem;
        color: #aaa;
        font-weight: 400;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 antialiased">
    <div
      class="container mx-auto px-2 sm:px-4 py-8 md:py-12 min-h-screen flex flex-col items-center justify-center"
    >
      <header class="text-center mb-8">
        <h1
          class="text-3xl md:text-4xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-gray-200 to-gray-400"
        >
          交互式 MacBook 键盘
        </h1>
        <p class="text-gray-400 text-sm md:text-base">
          按下键盘或点击按键查看效果，学习快捷功能。
        </p>
      </header>

      <!-- Keyboard Container -->
      <div
        id="keyboard-container"
        class="p-2 sm:p-4 bg-black bg-opacity-30 rounded-xl shadow-2xl shadow-gray-900/50 w-full max-w-5xl mx-auto"
      >
        <div class="space-y-1.5 md:space-y-2">
          <!-- Row 1: Function Keys -->
          <div class="flex space-x-1.5 md:space-x-2">
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1.5"
              data-key="Escape"
            >
              <span class="text-sm">esc</span>
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F1"
            >
              F1
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F2"
            >
              F2
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F3"
            >
              F3
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F4"
            >
              F4
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F5"
            >
              F5
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F6"
            >
              F6
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F7"
            >
              F7
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F8"
            >
              F8
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F9"
            >
              F9
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F10"
            >
              F10
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F11"
            >
              F11
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1"
              data-key="F12"
            >
              F12
            </div>
            <div
              class="key h-10 md:h-12"
              style="flex-basis: 0; flex-grow: 1.5"
              data-key="Power"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-5 h-5"
              >
                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                <line x1="12" y1="2" x2="12" y2="12"></line>
              </svg>
            </div>
          </div>

          <!-- Row 2: Number Keys -->
          <div class="flex space-x-1.5 md:space-x-2">
            <div
              class="key h-12 md:h-14"
              data-key="Backquote"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">~</span>`
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit1"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">!</span>1
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit2"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">@</span>2
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit3"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">#</span>3
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit4"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">$</span>4
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit5"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">%</span>5
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit6"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol"> ^ </span>6
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit7"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">&</span>7
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit8"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">*</span>8
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit9"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">(</span>9
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Digit0"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">)</span>0
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Minus"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">_</span>-
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Equal"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">+</span>=
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Backspace"
              style="flex-basis: 0; flex-grow: 1.5"
            >
              <span class="text-sm">delete</span
              ><span class="zh-label"> 删除 </span>
            </div>
          </div>

          <!-- Row 3: QWERTY -->
          <div class="flex space-x-1.5 md:space-x-2">
            <div
              class="key h-12 md:h-14"
              data-key="Tab"
              style="flex-basis: 0; flex-grow: 1.5"
            >
              <span class="text-sm">tab</span
              ><span class="zh-label"> 制表 </span>
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyQ"
              style="flex-basis: 0; flex-grow: 1"
            >
              Q
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyW"
              style="flex-basis: 0; flex-grow: 1"
            >
              W
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyE"
              style="flex-basis: 0; flex-grow: 1"
            >
              E
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyR"
              style="flex-basis: 0; flex-grow: 1"
            >
              R
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyT"
              style="flex-basis: 0; flex-grow: 1"
            >
              T
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyY"
              style="flex-basis: 0; flex-grow: 1"
            >
              Y
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyU"
              style="flex-basis: 0; flex-grow: 1"
            >
              U
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyI"
              style="flex-basis: 0; flex-grow: 1"
            >
              I
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyO"
              style="flex-basis: 0; flex-grow: 1"
            >
              O
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyP"
              style="flex-basis: 0; flex-grow: 1"
            >
              P
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="BracketLeft"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">{</span>[
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="BracketRight"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">}</span>]
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Backslash"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">|</span>\
            </div>
          </div>

          <!-- Row 4: ASDF (Home) -->
          <div class="flex space-x-1.5 md:space-x-2">
            <div
              class="key h-12 md:h-14"
              data-key="CapsLock"
              style="flex-basis: 0; flex-grow: 1.8"
            >
              <span class="text-sm">caps lock</span
              ><span class="zh-label"> 大写锁定 </span>
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyA"
              style="flex-basis: 0; flex-grow: 1"
            >
              A
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyS"
              style="flex-basis: 0; flex-grow: 1"
            >
              S
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyD"
              style="flex-basis: 0; flex-grow: 1"
            >
              D
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyF"
              style="flex-basis: 0; flex-grow: 1"
            >
              F
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyG"
              style="flex-basis: 0; flex-grow: 1"
            >
              G
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyH"
              style="flex-basis: 0; flex-grow: 1"
            >
              H
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyJ"
              style="flex-basis: 0; flex-grow: 1"
            >
              J
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyK"
              style="flex-basis: 0; flex-grow: 1"
            >
              K
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyL"
              style="flex-basis: 0; flex-grow: 1"
            >
              L
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Semicolon"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">:</span>;
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Quote"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">"</span>'
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Enter"
              style="flex-basis: 0; flex-grow: 1.8"
            >
              <span class="text-sm">return</span
              ><span class="zh-label"> 回车 </span>
            </div>
          </div>

          <!-- Row 5: ZXCV -->
          <div class="flex space-x-1.5 md:space-x-2">
            <div
              class="key h-12 md:h-14"
              data-key="ShiftLeft"
              style="flex-basis: 0; flex-grow: 2.3"
            >
              <span class="text-sm">shift</span
              ><span class="zh-label"> 上档 </span>
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyZ"
              style="flex-basis: 0; flex-grow: 1"
            >
              Z
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyX"
              style="flex-basis: 0; flex-grow: 1"
            >
              X
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyC"
              style="flex-basis: 0; flex-grow: 1"
            >
              C
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyV"
              style="flex-basis: 0; flex-grow: 1"
            >
              V
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyB"
              style="flex-basis: 0; flex-grow: 1"
            >
              B
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyN"
              style="flex-basis: 0; flex-grow: 1"
            >
              N
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="KeyM"
              style="flex-basis: 0; flex-grow: 1"
            >
              M
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Comma"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol"><</span>,
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Period"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">></span>.
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Slash"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="symbol">?</span>/
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="ShiftRight"
              style="flex-basis: 0; flex-grow: 2.3"
            >
              <span class="text-sm">shift</span
              ><span class="zh-label"> 上档 </span>
            </div>
          </div>

          <!-- Row 6: Modifiers -->
          <div class="flex space-x-1.5 md:space-x-2">
            <div
              class="key h-12 md:h-14"
              data-key="Fn"
              style="flex-basis: 0; flex-grow: 1.25"
            >
              <span class="text-sm">fn</span
              ><span class="zh-label"> 功能 </span>
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="ControlLeft"
              style="flex-basis: 0; flex-grow: 1.25"
            >
              <span class="text-sm">control</span
              ><span class="zh-label"> 控制 </span>
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="AltLeft"
              style="flex-basis: 0; flex-grow: 1.25"
            >
              <span class="text-sm">option</span
              ><span class="zh-label"> 选项 </span>
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="MetaLeft"
              style="flex-basis: 0; flex-grow: 1.5"
            >
              <span class="text-sm">command</span
              ><span class="zh-label"> 命令 </span>
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="Space"
              style="flex-basis: 0; flex-grow: 5.5"
            ></div>
            <!-- Space Bar -->
            <div
              class="key h-12 md:h-14"
              data-key="MetaRight"
              style="flex-basis: 0; flex-grow: 1.5"
            >
              <span class="text-sm">command</span
              ><span class="zh-label"> 命令 </span>
            </div>
            <div
              class="key h-12 md:h-14"
              data-key="AltRight"
              style="flex-basis: 0; flex-grow: 1"
            >
              <span class="text-sm">option</span
              ><span class="zh-label"> 选项 </span>
            </div>
            <div
              class="flex w-auto space-x-1.5 md:space-x-2"
              style="flex-basis: 0; flex-grow: 2.75"
            >
              <div class="key h-12 md:h-14 w-full" data-key="ArrowLeft">
                <svg
                  class="w-5 h-5"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
              </div>
              <div class="flex flex-col w-full space-y-1.5 md:space-y-2">
                <div class="key w-full h-full" data-key="ArrowUp">
                  <svg
                    class="w-5 h-5"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M5 15l7-7 7 7"
                    />
                  </svg>
                </div>
                <div class="key w-full h-full" data-key="ArrowDown">
                  <svg
                    class="w-5 h-5"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </div>
              </div>
              <div class="key h-12 md:h-14 w-full" data-key="ArrowRight">
                <svg
                  class="w-5 h-5"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Info Display Panel -->
      <div
        id="info-panel"
        class="mt-8 w-full max-w-5xl h-16 bg-black bg-opacity-20 rounded-lg flex items-center justify-center text-lg text-cyan-300 font-mono transition-opacity duration-200"
      >
        &nbsp;
      </div>
    </div>

    <script>
      const infoPanel = document.getElementById("info-panel");
      const allKeys = document.querySelectorAll(".key");
      const keyboardContainer = document.getElementById("keyboard-container");

      const keyNameMap = {
        Meta: " 命令 ",
        Shift: " 上档 ",
        Alt: " 选项 ",
        Control: " 控制 ",
        Fn: " 功能 ",
        Power: " 电源 ",
        Backspace: " 删除 ",
        Tab: " 制表 ",
        Enter: " 回车 ",
        Escape: " 退出 ",
        Space: " 空格 ",
        CapsLock: " 大写锁定 ",
        ArrowUp: " 上箭头 ",
        ArrowDown: " 下箭头 ",
        ArrowLeft: " 左箭头 ",
        ArrowRight: " 右箭头 ",
        Backquote: " 反引号 ",
        Minus: " 减号 ",
        Equal: " 等号 ",
        BracketLeft: " 左方括号 ",
        BracketRight: " 右方括号 ",
        Backslash: " 反斜杠 ",
        Semicolon: " 分号 ",
        Quote: " 引号 ",
        Comma: " 逗号 ",
        Period: " 句号 ",
        Slash: " 斜杠 ",
      };

      const shortcuts = {
        Power: " 长按以关机 / 轻点以睡眠 ",
        Fn: " 切换功能键 / 表情与符号 ",
        CapsLock: " 切换大写锁定 ",
        Tab: " 增加缩进 ",
        Shift_Tab: " 减小缩进 ",
        // Command
        Meta_KeyA: " 全选 ",
        Meta_KeyC: " 拷贝 ",
        Meta_KeyV: " 粘贴 ",
        Meta_KeyX: " 剪切 ",
        Meta_KeyZ: " 撤销 ",
        Meta_KeyS: " 保存 ",
        Meta_KeyF: " 查找 ",
        Meta_KeyG: " 查找下一个 ",
        Meta_KeyP: " 打印 ",
        Meta_KeyQ: " 退出应用 ",
        Meta_KeyW: " 关闭窗口 ",
        Meta_KeyN: " 新建 ",
        Meta_KeyT: " 新建标签页 ",
        Meta_KeyH: " 隐藏窗口 ",
        Meta_KeyM: " 最小化窗口 ",
        Meta_Space: " 聚焦搜索 ",
        Meta_Tab: " 切换应用 ",
        Meta_Backspace: " 删除文件 ",
        // Command + Shift
        Meta_Shift_KeyZ: " 重做 ",
        Meta_Shift_Digit3: " 截取全屏幕 ",
        Meta_Shift_Digit4: " 截取选定区域 ",
        Meta_Shift_Digit5: " 屏幕录制及截图选项 ",
        Meta_Shift_KeyN: " 新建文件夹 ",
        Meta_Shift_KeyG: " 前往文件夹 ",
        // Command + Option
        Meta_Alt_Escape: " 强制退出 ",
        Meta_Alt_KeyW: " 关闭所有窗口 ",
        // Control
        Control_KeyA: " 移至行首 ",
        Control_KeyE: " 移至行尾 ",
        // Shift (for symbol output)
        Shift_Digit1: " 输出 感叹号 !",
        Shift_Digit2: " 输出 艾特 @",
        Shift_Digit3: " 输出 井号 #",
        Shift_Digit4: " 输出 美元 $",
        Shift_Digit5: " 输出 百分号 %",
        Shift_Digit6: " 输出 插入符 ^ ",
        Shift_Digit7: " 输出 和号 &",
        Shift_Digit8: " 输出 星号 *",
        Shift_Digit9: " 输出 左圆括号 (",
        Shift_Digit0: " 输出 右圆括号 )",
        Shift_Minus: " 输出 下划线 _",
        Shift_Equal: " 输出 加号 +",
        Shift_Backquote: " 输出 波浪号 ~",
        Shift_Comma: " 输出 小于号 <",
        Shift_Period: " 输出 大于号 >",
        Shift_Slash: " 输出 问号 ?",
        Shift_Semicolon: " 输出 冒号 :",
        Shift_Quote: ' 输出 双引号 "',
        Shift_BracketLeft: " 输出 左花括号 {",
        Shift_BracketRight: " 输出 右花括号 }",
        Shift_Backslash: " 输出 竖线 |",
        // Function Keys
        F1: " 降低屏幕亮度 ",
        F2: " 提高屏幕亮度 ",
        F3: " 调度中心 ",
        F4: " 启动台 ",
        F5: " 降低键盘亮度 ",
        F6: " 提高键盘亮度 ",
        F7: " 上一首 ",
        F8: " 播放 / 暂停 ",
        F9: " 下一首 ",
        F10: " 静音 ",
        F11: " 减小音量 ",
        F12: " 增大音量 ",
      };

      const activeModifiers = new Set();
      const modifierKeyCodes = [
        "ControlLeft",
        "AltLeft",
        "MetaLeft",
        "MetaRight",
        "AltRight",
        "ShiftLeft",
        "ShiftRight",
      ];
      const modifierLogicalIds = ["Control", "Alt", "Meta", "Shift"];
      let needsReset = false;

      // -- Helper Functions --

      function getLogicalKeyId(keyCode) {
        if (keyCode.startsWith("Meta")) return "Meta";
        if (keyCode.startsWith("Alt")) return "Alt";
        if (keyCode.startsWith("Shift")) return "Shift";
        if (keyCode.startsWith("Control")) return "Control";
        return keyCode;
      }

      function getShortcutId(keysSet) {
        if (keysSet.size === 0) return null;

        const sortedModifiers = Array.from(keysSet)
          .filter((k) => modifierLogicalIds.includes(k))
          .sort(
            (a, b) =>
              modifierLogicalIds.indexOf(a) - modifierLogicalIds.indexOf(b)
          );
        const otherKeys = Array.from(keysSet).filter(
          (k) => !modifierLogicalIds.includes(k)
        );
        return [...sortedModifiers, ...otherKeys].join("_");
      }

      function formatKeyForDisplay(keyId) {
        return (
          keyNameMap[keyId] || keyId.replace("Key", "").replace("Digit", "")
        );
      }

      // -- Display and State Logic --

      function updateAndDisplay(keysSet) {
        const shortcutId = getShortcutId(keysSet);
        infoPanel.textContent = "\u00A0";

        if (shortcutId && shortcuts[shortcutId]) {
          const keys = shortcutId.split("_");
          const displayString = keys.map(formatKeyForDisplay).join(" + ");
          infoPanel.textContent = `${displayString} ：${shortcuts[shortcutId]}`;
        } else if (keysSet.size > 0) {
          const keyArray = Array.from(keysSet);
          const displayString = keyArray.map(formatKeyForDisplay).join(" + ");
          infoPanel.textContent = displayString;
        }
      }

      function resetState() {
        activeModifiers.clear();
        allKeys.forEach((kElem) => kElem.classList.remove("key-pressed"));
        infoPanel.textContent = "\u00A0";
        needsReset = false;
      }

      // -- Unified Input Handling --

      function handleInteraction(keyCode) {
        if (needsReset) {
          resetState();
        }

        const keyElement = document.querySelector(
          `.key[data-key="${keyCode}"]`
        );
        const keyId = getLogicalKeyId(keyCode);
        const isModifier = modifierKeyCodes.includes(keyCode);

        if (isModifier) {
          keyElement.classList.toggle("key-pressed");
          if (activeModifiers.has(keyId)) {
            activeModifiers.delete(keyId);
          } else {
            activeModifiers.add(keyId);
          }
          updateAndDisplay(activeModifiers);
          needsReset = false;
        } else {
          // Is a normal key
          const tempKeys = new Set(activeModifiers);
          tempKeys.add(keyId);

          allKeys.forEach((k) => k.classList.remove("key-pressed"));

          tempKeys.forEach((kId) => {
            const logicalId = getLogicalKeyId(kId);
            if (modifierLogicalIds.includes(logicalId)) {
              // This logic is tricky, we need to highlight the pressed physical keys
              // The 'activeModifiers' set holds logical IDs, which is the problem.
              // Let's change activeModifiers to hold the full keyCode.
              // This logic will be rewritten below.
            } else {
              document
                .querySelector(`[data-key="${kId}"]`)
                ?.classList.add("key-pressed");
            }
          });
          // Let's rewrite the highlight logic entirely here.
          activeModifiers.forEach((modId) => {
            document
              .querySelectorAll(`[data-key ^ ="${modId}"]`)
              .forEach((el) => el.classList.add("key-pressed"));
          });
          keyElement?.classList.add("key-pressed");

          updateAndDisplay(tempKeys);
          needsReset = true;
        }
      }

      // -- REFACTORED LOGIC --
      const heldModifiers = new Set(); // Holds full keyCodes like "MetaLeft"

      function handleInteractionRefactored(keyCode) {
        if (needsReset) {
          resetStateRefactored();
        }

        const keyElement = document.querySelector(
          `.key[data-key="${keyCode}"]`
        );
        const isModifier = modifierKeyCodes.includes(keyCode);

        if (isModifier) {
          keyElement.classList.toggle("key-pressed");
          if (heldModifiers.has(keyCode)) {
            heldModifiers.delete(keyCode);
          } else {
            heldModifiers.add(keyCode);
          }
          const logicalModifiers = new Set(
            Array.from(heldModifiers).map(getLogicalKeyId)
          );
          updateAndDisplay(logicalModifiers);
          needsReset = false;
        } else {
          // Is a normal key
          const logicalModifiers = new Set(
            Array.from(heldModifiers).map(getLogicalKeyId)
          );
          const logicalKeyId = getLogicalKeyId(keyCode);
          logicalModifiers.add(logicalKeyId);

          // Highlight
          allKeys.forEach((k) => k.classList.remove("key-pressed"));
          heldModifiers.forEach((modCode) => {
            document
              .querySelector(`[data-key="${modCode}"]`)
              ?.classList.add("key-pressed");
          });
          keyElement?.classList.add("key-pressed");

          updateAndDisplay(logicalModifiers);
          needsReset = true;
        }
      }

      function resetStateRefactored() {
        heldModifiers.clear();
        allKeys.forEach((kElem) => kElem.classList.remove("key-pressed"));
        infoPanel.textContent = "\u00A0";
        needsReset = false;
      }

      // -- Event Listeners --

      window.addEventListener("keydown", (e) => {
        e.preventDefault();
        handleInteractionRefactored(e.code);
      });

      keyboardContainer.addEventListener("mousedown", (e) => {
        const keyElement = e.target.closest(".key");
        if (!keyElement) return;
        handleInteractionRefactored(keyElement.dataset.key);
      });

      window.addEventListener("blur", () => {
        resetStateRefactored();
      });
    </script>
  </body>
</html>
